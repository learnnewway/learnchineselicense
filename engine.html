<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subject 1: Mass Ingestion Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Space+Grotesk:wght@500;700&display=swap');
        body { background-color: #fafaf9; color: #292524; font-family: 'Outfit', sans-serif; overflow-x: hidden; }
        h1, h2, h3 { font-family: 'Space Grotesk', sans-serif; letter-spacing: -0.03em; }
        .info-card { background: #ffffff; border-radius: 24px; box-shadow: 0 4px 20px -5px rgba(0,0,0,0.03); border: 1px solid #f5f5f4; position: relative; overflow: hidden; }
        .accent-bar-orange { border-left: 6px solid #ea580c; }
        .accent-bar-teal { border-top: 6px solid #0d9488; }
        .bento-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 1.5rem; }
        .col-12 { grid-column: span 12; } .col-8 { grid-column: span 8; } .col-4 { grid-column: span 4; }
        @media (max-width: 1024px) { .col-8, .col-4 { grid-column: span 12; } }
    </style>
</head>
<body class="p-4 md:p-8 lg:p-12">

    <div class="max-w-7xl mx-auto bento-grid">
        <header class="col-12 mb-4 flex flex-col md:flex-row justify-between items-end border-b-2 border-stone-200 pb-6 panel-animate">
            <div>
                <a href="index.html" class="inline-flex items-center text-sm font-bold text-stone-400 hover:text-orange-600 transition mb-4 uppercase tracking-wider bg-stone-50 px-4 py-2 rounded-lg border border-stone-200 shadow-sm">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Command Center
                </a>
                <h1 class="text-4xl md:text-6xl font-extrabold text-stone-800 mt-2">Database <span class="text-orange-600">Engine</span></h1>
            </div>
            <div class="text-right mt-4 md:mt-0 bg-white px-5 py-3 rounded-2xl shadow-sm border border-stone-100">
                <p class="text-stone-500 font-semibold text-sm">System Memory: <span id="memory-status" class="text-teal-600 font-bold">Active</span></p>
            </div>
        </header>

        <div id="dashboard-hub" class="col-12 bento-grid w-full m-0 p-0">
            <div class="col-8 info-card accent-bar-orange p-8 panel-animate flex flex-col justify-center">
                <h2 class="text-2xl font-bold text-stone-800 mb-2"><i class="fas fa-microchip text-orange-600 mr-2"></i> Dynamic Exam Generator</h2>
                <p class="text-stone-500 mb-8 font-medium">The system will cross-reference your local memory and pull exactly <strong class="text-stone-800">100 random, unseen questions</strong> from the master payload to simulate a real exam sheet.</p>
                
                <button onclick="fetchAndBootSimulator()" id="boot-btn" class="w-full bg-stone-50 border-2 border-stone-200 hover:bg-orange-500 hover:border-orange-600 hover:text-white text-stone-700 font-bold rounded-2xl p-10 transition-all duration-300 shadow-sm flex flex-col items-center justify-center group">
                    <i id="boot-icon" class="fas fa-power-off text-5xl mb-4 text-stone-300 group-hover:text-white transition-colors"></i>
                    <span id="boot-text" class="text-xl">Boot 100-Question Exam Sheet</span>
                </button>
            </div>

            <div class="col-4 info-card p-8 panel-animate bg-stone-900 text-stone-100 flex flex-col">
                <h2 class="text-xl font-bold text-white mb-6 flex items-center border-b border-stone-700 pb-4">
                    <span class="text-teal-400 mr-3"><i class="fas fa-chart-radar"></i></span> Pilot Records
                </h2>
                
                <div class="mb-6">
                    <p class="text-stone-400 text-xs font-bold uppercase tracking-wider mb-1">Global Progress</p>
                    <div class="w-full bg-stone-800 rounded-full h-2.5 mb-1">
                        <div id="global-progress-bar" class="bg-teal-500 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <p class="text-xs text-stone-500 font-medium text-right"><span id="seen-count">0</span> Questions Cleared</p>
                </div>

                <div class="mb-6 flex-grow">
                    <p class="text-stone-400 text-xs font-bold uppercase tracking-wider mb-2">High Scores (Latest)</p>
                    <ul id="score-log" class="space-y-2 text-sm font-medium text-stone-300">
                        <li class="text-stone-600 italic">No exams completed yet.</li>
                    </ul>
                </div>

                <div>
                    <p class="text-stone-400 text-xs font-bold uppercase tracking-wider mb-2">Critical Failure Points</p>
                    <ul id="error-log" class="space-y-2 text-xs font-medium text-stone-300 max-h-32 overflow-y-auto pr-2">
                        <li class="text-stone-600 italic">No error data accumulated.</li>
                    </ul>
                </div>
                
                <button onclick="clearMemory()" class="mt-6 text-xs text-stone-500 hover:text-red-400 transition text-right underline">Format Memory Drive</button>
            </div>
        </div>

        <div id="exam-engine" class="hidden col-12 info-card accent-bar-teal p-8 bg-teal-50/10 panel-animate relative overflow-hidden">
            <div class="absolute top-0 left-0 h-1 bg-stone-100 w-full">
                <div id="exam-progress-bar" class="h-full bg-teal-500 transition-all duration-300 w-0"></div>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 border-b border-stone-100 pb-6">
                <div>
                    <h2 class="text-2xl font-bold text-stone-800"><i class="fas fa-tachometer-alt text-teal-600 mr-2"></i> Live Telemetry</h2>
                    <p id="q-counter" class="text-stone-500 font-medium text-sm mt-1">Question 1 of 100</p>
                </div>
                <div class="flex space-x-3 text-sm font-bold mt-4 md:mt-0">
                    <span class="bg-white border border-stone-200 text-stone-600 px-4 py-2 rounded-xl shadow-sm">Score: <span id="score-correct" class="text-teal-600 text-lg ml-1">0</span></span>
                    <span class="bg-white border border-stone-200 text-stone-600 px-4 py-2 rounded-xl shadow-sm">Errors: <span id="score-wrong" class="text-red-500 text-lg ml-1">0</span></span>
                </div>
            </div>

            <div class="max-w-4xl mx-auto">
                <h3 id="question-text" class="text-2xl md:text-3xl font-bold text-stone-800 mb-8 leading-tight">Loading Payload...</h3>
                
                <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
                
                <div id="feedback-area" class="mt-8 hidden rounded-2xl p-6 font-bold text-sm border shadow-inner"></div>
                
                <div class="mt-8 flex flex-col md:flex-row justify-between items-center gap-4">
                    <button id="abort-btn" onclick="abortExam()" class="text-stone-400 hover:text-red-500 font-bold transition text-sm uppercase tracking-wider w-full md:w-auto text-left md:text-center p-2">
                        <i class="fas fa-times-circle mr-2"></i> End Simulation Early
                    </button>
                    
                    <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                        <button id="reveal-btn" onclick="revealAnswer()" class="px-8 py-4 bg-stone-100 text-stone-600 rounded-xl font-bold hover:bg-stone-200 hover:text-stone-800 transition shadow-sm w-full md:w-auto text-lg border border-stone-200">
                            <i class="fas fa-eye mr-2"></i> Reveal Answer
                        </button>
                        <button id="next-q-btn" class="hidden px-10 py-4 bg-stone-800 text-white rounded-xl font-bold hover:bg-stone-700 transition shadow-xl shadow-stone-900/10 w-full md:w-auto text-lg" onclick="nextQuestion()">
                            Next Parameter <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const STORAGE_KEY = 'subject1_telemetry';
        let telemetryData = { seen: [], errors: {}, history: [] };
        let sessionBank = [];
        let currentIndex = 0;
        let correctCount = 0;
        let wrongCount = 0;
        let totalMasterBankSize = 0;

        document.addEventListener("DOMContentLoaded", () => {
            gsap.fromTo(".panel-animate", { y: 30, opacity: 0 }, { y: 0, opacity: 1, duration: 0.6, stagger: 0.1, ease: "power3.out" });
            loadTelemetry();
            fetchMasterBankSize();
        });

        function loadTelemetry() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) telemetryData = JSON.parse(saved);
            updateDashboardUI();
        }

        function saveTelemetry() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(telemetryData));
        }

        function clearMemory() {
            if(confirm("WARNING: This will erase all your high scores and reset the unseen question filter. Proceed?")) {
                localStorage.removeItem(STORAGE_KEY);
                telemetryData = { seen: [], errors: {}, history: [] };
                updateDashboardUI();
                document.getElementById('global-progress-bar').style.width = '0%';
                document.getElementById('seen-count').innerText = '0';
            }
        }

        function updateDashboardUI() {
            const historyList = document.getElementById('score-log');
            if (telemetryData.history.length > 0) {
                historyList.innerHTML = '';
                telemetryData.history.slice(-5).reverse().forEach(run => {
                    const li = document.createElement('li');
                    const passColor = (run.score / run.total) >= 0.9 ? 'text-teal-400' : 'text-orange-400';
                    li.innerHTML = `<span class="${passColor} font-bold mr-2">${run.score}/${run.total}</span> <span class="text-stone-500 text-xs">${run.date}</span>`;
                    historyList.appendChild(li);
                });
            } else {
                historyList.innerHTML = '<li class="text-stone-600 italic">No exams completed yet.</li>';
            }

            const errorList = document.getElementById('error-log');
            const sortedErrors = Object.entries(telemetryData.errors).sort((a, b) => b[1] - a[1]).slice(0, 5);
            
            if (sortedErrors.length > 0) {
                errorList.innerHTML = '';
                sortedErrors.forEach(([question, count]) => {
                    const li = document.createElement('li');
                    li.className = "flex items-start border-b border-stone-800 pb-2 mb-2 last:border-0";
                    li.innerHTML = `<span class="bg-red-500/20 text-red-400 px-2 py-0.5 rounded mr-2 font-black shrink-0">${count}x</span> <span class="truncate" title="${question}">${question}</span>`;
                    errorList.appendChild(li);
                });
            } else {
                errorList.innerHTML = '<li class="text-stone-600 italic">No error data accumulated.</li>';
            }
        }

        function fetchMasterBankSize() {
            Papa.parse("mock_test_alpha.csv", {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if(results.data && results.data.length > 0) {
                        totalMasterBankSize = results.data.length;
                        document.getElementById('seen-count').innerText = telemetryData.seen.length;
                        let pct = Math.min((telemetryData.seen.length / totalMasterBankSize) * 100, 100);
                        document.getElementById('global-progress-bar').style.width = `${pct}%`;
                    }
                }
            });
        }

        function fetchAndBootSimulator() {
            const btn = document.getElementById('boot-btn');
            document.getElementById('boot-icon').className = "fas fa-circle-notch fa-spin text-5xl mb-4 text-orange-500";
            document.getElementById('boot-text').innerText = "Extracting Payload...";
            btn.classList.add('pointer-events-none');

            Papa.parse("mock_test_alpha.csv", {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.errors.length > 0 && results.data.length === 0) {
                        alert("Error: mock_test_alpha.csv not found on server.");
                        resetBootBtn();
                        return;
                    }

                    const masterBank = results.data;
                    let unseenBank = masterBank.filter(q => !telemetryData.seen.includes(q.Question));
                    
                    if (unseenBank.length === 0) {
                        alert("Database exhausted! You have answered every question in the payload. Memory banks are resetting for a new cycle.");
                        telemetryData.seen = [];
                        saveTelemetry();
                        unseenBank = masterBank;
                        document.getElementById('seen-count').innerText = '0';
                        document.getElementById('global-progress-bar').style.width = '0%';
                    }

                    unseenBank = unseenBank.sort(() => Math.random() - 0.5); 
                    sessionBank = unseenBank.slice(0, 100);
                    
                    currentIndex = 0; correctCount = 0; wrongCount = 0;
                    document.getElementById('score-correct').innerText = "0";
                    document.getElementById('score-wrong').innerText = "0";

                    document.getElementById('dashboard-hub').classList.add('hidden');
                    document.getElementById('exam-engine').classList.remove('hidden');
                    
                    loadQuestion();
                },
                error: function() {
                    alert("Network error: Could not fetch the CSV file.");
                    resetBootBtn();
                }
            });
        }

        function resetBootBtn() {
            const btn = document.getElementById('boot-btn');
            document.getElementById('boot-icon').className = "fas fa-power-off text-5xl mb-4 text-stone-300 group-hover:text-white transition-colors";
            document.getElementById('boot-text').innerText = "Boot 100-Question Exam Sheet";
            btn.classList.remove('pointer-events-none');
        }

        function loadQuestion() {
            if (currentIndex >= sessionBank.length) {
                finishExam(false);
                return;
            }

            const qData = sessionBank[currentIndex];
            document.getElementById('q-counter').innerText = `Question ${currentIndex + 1} of ${sessionBank.length}`;
            document.getElementById('question-text').innerText = qData.Question;
            
            if(!telemetryData.seen.includes(qData.Question)) {
                telemetryData.seen.push(qData.Question);
            }
            saveTelemetry();
            
            const optionsGrid = document.getElementById('options-grid');
            optionsGrid.innerHTML = '';
            
            const options = ['A', 'B', 'C', 'D'];
            options.forEach(opt => {
                if(qData[opt]) {
                    const btn = document.createElement('button');
                    btn.className = 'text-left p-5 rounded-xl bg-white border-2 border-stone-100 hover:border-teal-400 hover:bg-teal-50 text-stone-700 font-bold transition shadow-sm text-lg';
                    btn.innerText = `${opt}. ${qData[opt]}`;
                    btn.onclick = () => checkAnswer(opt, qData.Answer, qData.Explanation, btn, qData.Question);
                    optionsGrid.appendChild(btn);
                }
            });

            document.getElementById('feedback-area').classList.add('hidden');
            document.getElementById('next-q-btn').classList.add('hidden');
            document.getElementById('reveal-btn').classList.remove('hidden'); // Show Reveal button
            document.getElementById('exam-progress-bar').style.width = `${(currentIndex / sessionBank.length) * 100}%`;
        }

        function checkAnswer(selectedOpt, correctOpt, explanation, btnElement, questionText) {
            const feedback = document.getElementById('feedback-area');
            const buttons = document.getElementById('options-grid').children;
            
            for(let b of buttons) { b.disabled = true; b.classList.add('opacity-50', 'cursor-not-allowed'); b.classList.remove('hover:border-teal-400', 'hover:bg-teal-50'); }
            
            feedback.className = 'mt-8 rounded-2xl p-6 font-bold text-base border shadow-inner';

            const sel = selectedOpt.trim().toUpperCase();
            const cor = correctOpt ? correctOpt.trim().toUpperCase() : "";

            if (sel === cor) {
                correctCount++;
                document.getElementById('score-correct').innerText = correctCount;
                btnElement.classList.replace('bg-white', 'bg-teal-500'); btnElement.classList.replace('border-stone-100', 'border-teal-600'); btnElement.classList.replace('text-stone-700', 'text-white'); btnElement.classList.remove('opacity-50');
                feedback.innerHTML = `<div class="flex items-start"><i class="fas fa-check-circle text-2xl mr-3 mt-1 text-teal-600"></i> <div><span class="text-teal-900 text-lg">Correct Vector.</span><br><span class="text-teal-800 font-medium mt-1 block">${explanation || ''}</span></div></div>`; 
                feedback.classList.add('bg-teal-50', 'border-teal-200');
            } else {
                wrongCount++;
                document.getElementById('score-wrong').innerText = wrongCount;
                
                telemetryData.errors[questionText] = (telemetryData.errors[questionText] || 0) + 1;
                saveTelemetry();

                btnElement.classList.replace('bg-white', 'bg-red-500'); btnElement.classList.replace('border-stone-100', 'border-red-600'); btnElement.classList.replace('text-stone-700', 'text-white'); btnElement.classList.remove('opacity-50');
                feedback.innerHTML = `<div class="flex items-start"><i class="fas fa-times-circle text-2xl mr-3 mt-1 text-red-600"></i> <div><span class="text-red-900 text-lg">Incorrect. The proper protocol was ${cor}.</span><br><span class="text-red-800 font-medium mt-1 block">${explanation || ''}</span></div></div>`; 
                feedback.classList.add('bg-red-50', 'border-red-200');
                
                for(let b of buttons) {
                    if(b.innerText.startsWith(cor)) {
                        b.classList.replace('bg-white', 'bg-teal-500'); b.classList.replace('border-stone-100', 'border-teal-600'); b.classList.replace('text-stone-700', 'text-white'); b.classList.remove('opacity-50');
                    }
                }
            }
            
            document.getElementById('reveal-btn').classList.add('hidden'); // Hide reveal
            document.getElementById('next-q-btn').classList.remove('hidden');
        }

        // NEW: Reveal Logic
        function revealAnswer() {
            const qData = sessionBank[currentIndex];
            const feedback = document.getElementById('feedback-area');
            const buttons = document.getElementById('options-grid').children;
            const cor = qData.Answer ? qData.Answer.trim().toUpperCase() : "";

            // Lock options
            for(let b of buttons) { b.disabled = true; b.classList.add('opacity-50', 'cursor-not-allowed'); b.classList.remove('hover:border-teal-400', 'hover:bg-teal-50'); }
            
            // Mark as wrong/revealed to track weakness
            wrongCount++;
            document.getElementById('score-wrong').innerText = wrongCount;
            telemetryData.errors[qData.Question] = (telemetryData.errors[qData.Question] || 0) + 1;
            saveTelemetry();

            // Highlight correct
            for(let b of buttons) {
                if(b.innerText.startsWith(cor)) {
                    b.classList.replace('bg-white', 'bg-teal-500'); b.classList.replace('border-stone-100', 'border-teal-600'); b.classList.replace('text-stone-700', 'text-white'); b.classList.remove('opacity-50');
                }
            }

            feedback.className = 'mt-8 rounded-2xl p-6 font-bold text-base border shadow-inner bg-stone-50 border-stone-200';
            feedback.innerHTML = `<div class="flex items-start"><i class="fas fa-eye text-2xl mr-3 mt-1 text-stone-500"></i> <div><span class="text-stone-800 text-lg">Answer Revealed: ${cor}</span><br><span class="text-stone-600 font-medium mt-1 block">${qData.Explanation || 'No explanation provided.'}</span></div></div>`; 
            feedback.classList.remove('hidden');

            document.getElementById('reveal-btn').classList.add('hidden');
            document.getElementById('next-q-btn').classList.remove('hidden');
        }

        function nextQuestion() {
            currentIndex++;
            loadQuestion();
        }

        // NEW: Abort Logic
        function abortExam() {
            if(confirm("Are you sure you want to end the simulation early? Your score will be calculated based on the questions you have answered so far.")) {
                finishExam(true);
            }
        }

        function finishExam(isEarly = false) {
            document.getElementById('exam-progress-bar').style.width = '100%';
            
            const totalAttempted = isEarly ? currentIndex : sessionBank.length;
            
            if (totalAttempted > 0) {
                const today = new Date().toLocaleDateString();
                telemetryData.history.push({ date: today, score: correctCount, total: totalAttempted });
                saveTelemetry();

                const passMark = (correctCount / totalAttempted) >= 0.9;
                const msg = passMark ? "CONGRATULATIONS. Flight clearance granted." : "FAILURE. License load factor exceeded.";
                
                alert(`Simulation ${isEarly ? 'Aborted' : 'Complete'}.\nFinal Score: ${correctCount}/${totalAttempted}\n${msg}`);
            } else {
                alert("Simulation Aborted. No data recorded.");
            }
            
            // Return to dashboard
            window.location.reload();
        }
    </script>
</body>
</html>
